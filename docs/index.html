<!DOCTYPE html>
<html>

<head>

  <meta name="description" content="Some interactive maps made with D3.js">
  <meta name="author" content="Cornelia Gamst">

  <meta property="og:title" content="Maps with D3.js">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://gamst.github.io/d3-maps">
  <meta property="og:description" content="Some interactive maps made with D3.js">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
  <!-- <meta property="og:image" content="/warnstreik-gew/image.jpg">

    <link rel="icon" type="image/png" href="/warnstreik-gew/strike.png"> -->

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>D3 Maps</title>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
    }

    #map-container {
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
    }

    path {
      stroke: white;
      stroke-width: 0.5px;
      fill: #3A2A78;
    }

    path:hover {
      fill: #6c609a;
    }

    .tooltip {
      width: 230px;
    }

    .city {
      font-weight: bold;
      padding: 10px;
      font-size: 14px;
    }

    .accordion {
      background-color: #DFDFDF;
      color: #444;
      cursor: pointer;
      width: 100%;
      text-align: left;
      border: none;
      outline: none;
      transition: 0.4s;
      border-top: 1px solid grey;
      padding: 10px;
      font-size: 14px;
    }

    .active,
    .accordion:hover {
      background-color: #ccc;
    }

    .panel {
      padding: 0 18px;
      background-color: #B7B7B7;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
      color: #444;
      font-size: 14px;
    }

    .accordion:after {
      content: "\2193";
      font-size: 11px;
      color: #777;
      float: right;
      margin-left: 5px;
    }

    .active:after {
      content: "\2191";
    }

    .dot {
      width: 9px;
      height: 9px;
      border-radius: 100%;
      display: inline-block;
      margin-right: 5px;
    }

    .green {
      background-color: green;
    }

    .blue {
      background-color: blue;
    }

    .white {
      background-color: white;
    }

    @media (max-width: 1000px) {
      .city {
        font-size: 12px;
      }

      .accordion {
        font-size: 12px;
      }

      .panel {
        font-size: 12px;
      }
    }

    @media (max-width: 700px) {
      .tooltip {
        width: 140px;
      }

      .dot {
        width: 6px;
        height: 6px;
      }

      .tooltip {
        width: 160px;
      }

      .city {
        font-size: 10px;
      }

      .accordion {
        font-size: 10px;
      }

      .panel {
        font-size: 10px;
      }
    }

    @media (max-width: 450px) {
      .tooltip {
        width: 135px;
      }

      .city {
        font-size: 8px;
      }

      .accordion {
        font-size: 8px;
      }

      .panel {
        font-size: 8px;
      }
    }
  </style>

  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/topojson.v0.min.js"></script>
</head>

<body>
  <div id="map-container"></div>

  <script type="text/javascript">
    var width = null;
    var height = null
    var scale = 0;
    var svg = null
    var tooltip = null;
    var projection = null;
    var path = null;
    var g = null;

    function showInformation(element) {
      element.classList.toggle("active");
      var panel = element.nextElementSibling;
      if (panel.style.maxHeight) {
        panel.style.maxHeight = null;
      } else {
        panel.style.maxHeight = panel.scrollHeight + "px";
      }
    }

    function getDotColor(category) {
      let result = "";
      if (category === "Konsortialpartner" || category === "Nutzungspartner") {
        result = "blue";
      } else if (category === "Fellowship") {
        result = "green";
      } else if (category === "Lernangebot") {
        result = "white";
      }
      return result;
    }

    function drawMap() {
      width = document.getElementById("map-container").getBoundingClientRect().width;
      height = document.getElementById("map-container").getBoundingClientRect().height;
      scale = 0;

      if (width < 450) {
        scale = 2100;
      } else if (width < 600) {
        scale = 2400;
      } else if (width < 1000) {
        scale = 3500;
      } else if (width < 1500) {
        scale = 5000;
      } else if (width < 2000) {
        scale = 6000;
      }

      d3.select("#map-container").html("");

      svg = d3.select("#map-container").append("svg")
        .attr("width", width)
        .attr("height", height);

      tooltip = d3.select("body").append("div")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("display", "none")
        .style("background", "#EAF4F8")
        .attr("class", "tooltip")
        .on('mouseleave', function () { return tooltip.style("display", "none"); });

      //changing the projection from mercator to albers
      projection = d3.geo.albers()
        .center([10.42, 50.7])
        .rotate([0, 0])
        .parallels([50, 10])
        .scale(scale)
        .translate([width / 2, height / 2]);

      path = d3.geo.path()
        .projection(projection);

      g = svg.append("g");

      //zoom and pan functionality
      var zoom = d3.behavior.zoom()
        .scaleExtent([1, 6])
        .on("zoom", function () {
          g.attr("transform", "translate(" + d3.event.translate.join(",") + ")scale(" + d3.event.scale + ")");
          g.selectAll("path")
            .attr("d", path.projection(projection));
        });
      svg.call(zoom);
    }

    function addCityLocations(cities) {
      d3.json("https://raw.githubusercontent.com/deldersveld/topojson/master/countries/germany/germany-regions.json", function (error, topology) {
        g.selectAll("path")
          .data(topojson.object(topology, topology.objects.DEU_adm2)
            .geometries)
          .enter()
          .append("path")
          .attr("d", path)
          .attr('fill', 'gray');

        // add city location circles
        g.selectAll("circle")
          .data(Object.values(cities))
          .enter()
          .append("circle")
          .attr("cx", function (d) { return projection([d.lon, d.lat])[0]; })
          .attr("cy", function (d) { return projection([d.lon, d.lat])[1]; })
          .attr("r", 5)
          .style("fill", "#17a468")
          .style("opacity", 0.6)
          .on('mouseover', function (d) {
            d3.select(this).style('fill', '#EAF4F8');
            const city = `<div class="city">${d.city}</div>`;
            const institutions = d.institutions.map((institution) => `
                <button class="accordion" onclick="showInformation(this)">
                  <div class="dot ${getDotColor(institution.category)}"></div>${institution.name}
                </button>
                <div class="panel">
                  <p>Person: ${institution.person}</p>
                  <p>Study track: ${institution.studyTrack}</p>
                </div>
              `).join('');
            tooltip.html(city + institutions);
            tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX - 3) + "px")
            return tooltip.style("display", "block");
          })
          .on('mouseleave', function () { return d3.select(this).style('fill', '#17a468'); });
      });
    }

    function generateMap() {
      d3.csv("./data/partners.csv", function (data) {
        let parsedData = {};

        for (var i = 0; i < data.length; i++) {
          if (parsedData[data[i].city] === undefined) {
            parsedData[data[i].city] = {
              city: data[i].city,
              lat: data[i].lat,
              lon: data[i].lon
            };
          }
          if (parsedData[data[i].city]['institutions'] === undefined) {
            parsedData[data[i].city]['institutions'] = [{
              name: data[i].name,
              category: data[i].category,
              person: data[i].person,
              studyTrack: data[i].study_track
            }]
          } else {
            parsedData[data[i].city]['institutions'].push({
              name: data[i].name,
              category: data[i].category,
              person: data[i].person,
              studyTrack: data[i].study_track
            });
          }
        }

        drawMap();
        addCityLocations(parsedData);
      });
    }

    window.addEventListener("resize", function () {
      generateMap();
    });

    window.addEventListener("load", function () {
      generateMap();
    });
  </script>
</body>

</html>