<!DOCTYPE html>
<html>

<head>

  <meta name="description" content="Some interactive maps made with D3.js">
  <meta name="author" content="Cornelia Gamst">

  <meta property="og:title" content="Maps with D3.js">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://gamst.github.io/d3-maps">
  <meta property="og:description" content="Some interactive maps made with D3.js">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
  <!-- <meta property="og:image" content="/warnstreik-gew/image.jpg">

    <link rel="icon" type="image/png" href="/warnstreik-gew/strike.png"> -->

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>D3 Maps</title>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    path {
      stroke: #FFFFFF;
      stroke-width: 0.5px;
      fill: #3A2A78;
    }

    path:hover {
      fill: rgb(174, 130, 185);
    }

    .tooltip {
      width: 230px;
      padding: 7px;
      border-radius: 2px;
      box-shadow: 0px 0px 10px 5px rgba(0, 0, 0, 0.3);
      -webkit-box-shadow: 0px 0px 10px 5px rgba(0, 0, 0, 0.3);
      -moz-box-shadow: 0px 0px 10px 5px rgba(0, 0, 0, 0.3);
    }

    .city {
      font-weight: bold;
      padding: 5px;
      font-size: 14px;
      color: #FFFFFF;
      background-color: rgb(243, 146, 0);
      border-bottom: 1px solid lightgrey;
    }

    .institution {
      padding: 5px;
      font-size: 14px;
      font-weight: bold;
      border-bottom: 1px solid lightgrey;
      cursor: pointer;
    }

    @media (max-width: 1000px) {
      .city {
        font-size: 12px;
      }

      .institution {
        font-size: 12px;
      }
    }

    @media (max-width: 700px) {
      .tooltip {
        width: 160px;
      }

      .city {
        font-size: 10px;
      }

      .institution {
        font-size: 10px;
      }
    }

    @media (max-width: 450px) {
      .tooltip {
        width: 30%;
      }

      .city {
        font-size: 8px;
      }

      .institution {
        font-size: 8px;
      }
    }
  </style>

  <script src="https://d3js.org/d3.v3.min.js"></script>
</head>

<body>
  <script type="text/javascript">
    // This object defines the font color and background color of different categories.
    // We can add more categories in this object and the implementation will still work.
    var categories = {
      "Partner": { fontColor: '#FFFFFF', backgroundColor: '#1AA469' },
      "Lehr-Fellowship": { fontColor: '#FFFFFF', backgroundColor: '#2891ba' },
      "KI-Campus-Original": { fontColor: '#000000', backgroundColor: '#eaf4f8' }
    };

    var width = null;
    var height = null
    var scale = 0;
    var svg = null
    var tooltip = null;
    var projection = null;
    var path = null;
    var g = null;

    function drawMap() {
      width = document.body.getBoundingClientRect().width;
      height = document.body.getBoundingClientRect().height;
      scale = 0;

      if (width < 450) {
        scale = 2100;
      } else if (width < 600) {
        scale = 2400;
      } else if (width < 1000) {
        scale = 3500;
      } else if (width < 1500) {
        scale = 5000;
      } else if (width < 2000) {
        scale = 6000;
      }

      if (height <= 400) {
        scale = 2500;
      } else if (height < 700) {
        scale = 3000;
      } else if (height <= 800) {
        scale = 3500;
      }

      d3.select("body").html("");

      svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

      tooltip = d3.select("body").append("div")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("display", "none")
        .style("background", "#FFFFFF")
        .attr("class", "tooltip")
        .on('mouseleave', function () { return tooltip.style("display", "none"); });

      //changing the projection from mercator to albers
      projection = d3.geo.albers()
        .center([10.42, 50.7])
        .rotate([0, 0])
        .parallels([50, 10])
        .scale(scale)
        .translate([width / 2, height / 2]);

      path = d3.geo.path()
        .projection(projection);

      g = svg.append("g");

      //zoom and pan functionality
      var zoom = d3.behavior.zoom()
        .scaleExtent([1, 6])
        .on("zoom", function () { });
      svg.call(zoom);
    }

    function addCityLocations(cities) {
      d3.json("./data/3_mittel.geo.json", function (geojson) {
        g.selectAll("path")
          .data(geojson.features)
          .enter()
          .append("path")
          .attr("d", path)
          .attr('fill', 'gray');

        // add city location circles
        g.selectAll("circle")
          .data(Object.values(cities))
          .enter()
          .append("circle")
          .attr("cx", function (d) { return projection([d.lon, d.lat])[0]; })
          .attr("cy", function (d) { return projection([d.lon, d.lat])[1]; })
          .attr("r", 3.5)
          .style("fill", "#17a468")
          .style("opacity", 1.0)
          .on('mouseover', function (d) {
            d3.select(this).style('fill', '#EAF4F8');
            const city = `<div class="city">${d.city}</div>`;
            const institutions = d.institutions.map((institution) => `
                <div
                  class="institution"
                  onclick="window.location.href = '${institution.url}';"
                  style="
                    background-color: ${categories[institution.category.trim()].backgroundColor}; color: ${categories[institution.category.trim()].fontColor}
                  ">
                  ${institution.name}
                </div>
              `).join('');
            tooltip.html(city + institutions);
            tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX - 3) + "px")
            return tooltip.style("display", "block");
          })
          .on('mouseleave', function () { return d3.select(this).style('fill', '#17a468'); });
      });
    }

    function generateMap() {
      d3.csv("./data/partners.csv", function (data) {
        let parsedData = {};

        for (var i = 0; i < data.length; i++) {
          if (parsedData[data[i].city] === undefined) {
            parsedData[data[i].city] = {
              city: data[i].city,
              land: data[i].land,
              lat: data[i].lat,
              lon: data[i].lon
            };
          }
          if (parsedData[data[i].city]['institutions'] === undefined) {
            parsedData[data[i].city]['institutions'] = [{
              name: data[i].name,
              category: data[i].category,
              url: data[i].url
            }]
          } else {
            parsedData[data[i].city]['institutions'].push({
              name: data[i].name,
              category: data[i].category,
              url: data[i].url
            });
          }
        }

        drawMap();
        addCityLocations(parsedData);
      });
    }

    window.addEventListener("resize", function () {
      generateMap();
    });

    window.addEventListener("load", function () {
      generateMap();
    });
  </script>
</body>

</html>